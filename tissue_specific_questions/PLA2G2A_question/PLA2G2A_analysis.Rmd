---
title: "question_maker"
author: "Tim Nieuwenhuis"
date: "6/14/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(DESeq2)
library(tidyverse)
library(lme4)
library(lmerTest)
source("../../global_in/general_scripts.R")
```

We think PLAG2A might be related to hardy scale and wish to explore it

```{r}

## Load SUBJ data
phen_dat <- read.csv("../../global_in/gtex_phenotypes_v8.csv")
dth_dat <- select(phen_dat, SUBJID, TRISCHD, DTHHRDY, MHBCTINF)%>%
    mutate(DTHHRDY = factor(DTHHRDY,levels = c(1, 2, 3,4, 0),ordered = T),
           MHBCTINF = factor(MHBCTINF))
## Load samp data.
samp_dat <- read.delim("../../global_in/GTEx_Analysis_v8_Annotations_SampleAttributesDS.txt", fill=T,
                      stringsAsFactors=FALSE, sep="\t", header=T)
## Load common subj_dat
subj_dat <- read.delim("../../global_in/GTEx_Analysis_v8_Annotations_SubjectPhenotypesDS.txt", fill=T,
                      stringsAsFactors=FALSE, sep="\t", header=T)
# dth_dat <- select(subj_dat, SUBJID, DTHHRDY,) %>%
#     mutate(DTHHRDY = factor(DTHHRDY,levels = c(1, 2, 3,4, 0),ordered = T))
## Load keys 
key_dat <- read.csv("../../automated_cluster_analysis/data_out/key_table.csv")


## load manual curation
man_cur <- read.csv("../../manual_cluster_analysis/manual_curation.csv")

```


Find out which cluster have plag2a and find out how many genes are associated
in those clusters
```{r}
### Select variable of interest
gene_of_interest <- "PLA2G2A"
## Covariates, lead with the one you want the results for
covars <- c("MHBCTINF", "TRISCHD")


clusters_with_pla <- str_detect(man_cur$genes, gene_of_interest)
pla2g_clusters <- man_cur[clusters_with_pla,]
pla2g_clusters <- pla2g_clusters %>% select(label, genes, ischemic_sig) %>%
    mutate(n_genes = str_count(genes, ";") + 1)

pla_key_dat <- filter(key_dat, label %in% pla2g_clusters$label,
                      !str_detect(label, "X"))
```
 Pull in clusters associated with Pla2ga
```{r}
model_res <- NULL
plot_list <- list()
all_dat <- NULL
for (pla_clust_ind in seq(nrow(pla_key_dat))) {
    cur_label <- (pla_key_dat$label)[pla_clust_ind]
    cur_tiss <- (pla_key_dat$r_names)[pla_clust_ind]
    cur_clust <- pla_key_dat$cluster[pla_clust_ind]
    path_to_profile <- paste0("../../MARCC output/variance_profiles_kendall/",
                              "kendall-",cur_tiss,"-cluster-profiles.csv")
    ## equation
    profile_dat <- read.csv(path_to_profile) %>%
        select(SAMPID = X,pla_clust = cur_clust) %>%
        mutate(SUBJID = GTEx_SAMPID_to_SUBJID(SAMPID)) %>%
        left_join(dth_dat)
    lm_res <- summary(lm(pla_clust ~ DTHHRDY + TRISCHD, data= profile_dat))
    new_row <- cbind(cur_label, broom::tidy(lm_res)[2,])
    all_dat <- rbind(all_dat, broom::tidy(lm_res))
    model_res <- rbind(model_res, broom::tidy(lm_res))
    ## Plot
    plt <- ggplot(profile_dat, aes(DTHHRDY, pla_clust)) +
        ggforce::geom_sina()+
        labs(title=cur_label) + theme_classic()
    plot_list[[cur_label]] <- plt
}
colnames(model_res)[1] <- "label"
joined_dat <- left_join((model_res), pla2g_clusters) %>%
    mutate(pval_adj = p.adjust(p.value, n = nrow(model_res),method = "fdr"))

write.csv(joined_dat,
          paste0("data_out/",
                gene_of_interest,
                "_DTHHRDY_results.csv"), row.names = F)

pdf(paste0("data_out/",gene_of_interest,
           "_DTHHRDY_plots.pdf"), width = 10, height = 8)
for (cur_plot in plot_list) {
 print(cur_plot)   
}
dev.off()
```

I want to see what I can understand about PLA2G2A in the context of other variable. It does not show up as a sig finding in a controlled linear model in any tissue [https://www.nature.com/articles/s41467-017-02772-x#MOESM1] and so I am going to try to see if I can understand it in the context of varaibles controlled for

Load in data
```{r}
all_plag2_expression <- GenesFromTissues(genes_of_int =  "PLA2G2A",key_dat = key_dat,run_all_available = T,vst_location = "../../Setup Code/output/")

all_plag2_expression_join <- left_join(all_plag2_expression, samp_dat) %>%
    left_join(., phen_dat)

adipose_sub_plag <- all_plag2_expression_join %>%
    filter(tissue == "adipose_subcutaneous")
```

Simply look at ADPSBQ plag2a2 ~ simple model and then ~ complex model
```{r}
broom::tidy(lm(PLA2G2A ~ SMTSISCH, data = adipose_sub_plag))

## Lacking:
## SMCAT: Category or classifier of a set of responses, indicates the color of the sample collection kit
## SMTSTPTREF Time point reference for Start and End times of sample procurement
all_out <- broom::tidy(lm(PLA2G2A ~ SMTSISCH + AGE + HGHT+ WGHT + BMI + ETHNCTY + SEX + MHCANCERNM +SMRIN +SMATSSCR  +SMCENTER  + SMNABTCH + COHORT, data = adipose_sub_plag))
all_out
## Ischemic is still one of the bigger results
```


```{r}
lmer_res <- lmer(PLA2G2A ~ SMTSISCH + AGE + HGHT+ WGHT + BMI + ETHNCTY + SEX + MHCANCERNM +SMRIN +SMATSSCR  +SMCENTER  + SMNABTCH + COHORT + (1|tissue), data = all_plag2_expression_join)

summary(lmer_res)

## No vent
no_vent_dat <- all_plag2_expression_join %>%
    filter(DTHVNT == 0)
vent_dat <- all_plag2_expression_join %>%
    filter(DTHVNT == 1)

lmer_no_vent <- lmer(PLA2G2A ~ SMTSISCH + AGE + HGHT+ WGHT + BMI + ETHNCTY + SEX + MHCANCERNM +SMRIN +SMATSSCR  +SMCENTER  + SMNABTCH + COHORT + (1|tissue), data = no_vent_dat)

summary(lmer_no_vent)

lmer_vent <- lmer(PLA2G2A ~ SMTSISCH + AGE + HGHT+ WGHT + BMI + ETHNCTY + SEX + MHCANCERNM +SMRIN +SMATSSCR  +SMCENTER  + SMNABTCH + COHORT + (1|tissue), data = vent_dat)

summary(lmer_no_vent)
```

