---
title: "Understanding mitochondria genes"
author: "Tim N"
date: "10/8/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(RColorBrewer)
source("../../global_in/general_scripts.R")
```

```{r}
cluster_list <- AllGeneClusterPuller("../../MARCC output/variance_genes_kendall/")
manual_curation <- read.csv("../../manual_cluster_analysis/manual_curation.csv")
key_dat <- read.csv("../../automated_cluster_analysis/data_out/key_table.csv")
phen_dat <- read.csv("../../global_in/gtex_phenotypes_v8.csv")
samp_dat <- data.table::fread("../../global_in/GTEx_Analysis_v8_Annotations_SampleAttributesDS.txt")
```


```{r}
cluster_mito <- c("MTCO3P12",
"MTCO1P12",
"MTND1P23",
"MTND2P28",
"MT−TS1",
"MTND4P12",
"MT−TE",
"MTATP8P1",
"MTCO2P12",
"MT−TY",
"MT−TL2",
"MT−TP")
```



Load a brain z-score with mitochondrial genes
```{r}
brain_profs <- ZscoreProfilePuller(r_name_vect =  c("brain_cerebellum",
                                                    "brain_cortex",
                                                    "brain_substantia_nigra"),
                                   location = "../../MARCC output/variance_profiles_kendall/")
cereb_mito <- brain_profs$brain_cerebellum %>% select(SUBJID, cereb_samp = SAMPID, cereb_mito = A)
cereb_samp <- brain_profs$brain_cerebellum %>% select(SUBJID, SAMPID, cereb_mito = A)
cortex_mito <- brain_profs$brain_cortex %>% select(SUBJID,corex_sam = SAMPID, cortex_mito = A)
cortex_samp <- brain_profs$brain_cortex %>% select(SUBJID, SAMPID, cortex_mito = A)

join_brain <- left_join(cereb_mito,cortex_mito)%>%
    left_join(.,phen_dat)


join_brain %>%
    ggplot(., aes(cereb_mito, cortex_mito)) +
    geom_point() 

join_brain %>%
    ggplot(., aes(factor(COHORT), cortex_mito)) +
    ggforce::geom_sina()

join_brain %>%
    ggplot(., aes((DTHRFGD), cortex_mito)) +
    geom_point()
```


```{r}
cereb_samp <- left_join(cereb_samp,phen_dat) %>% left_join(., samp_dat) %>%
    mutate(SMGEBTCHD = as.Date(SMGEBTCHD,format = "%m/%d/%Y"))
cortex_samp<- left_join(cortex_samp,phen_dat) %>% left_join(., samp_dat)
ggplot(cereb_samp, aes(factor(SMGEBTCHT), cereb_mito)) +
    ggforce::geom_sina()

ggplot(cortex_samp, aes(SMRIN, cortex_mito)) +
    geom_point()


summary(lm(cereb_mito ~ SMRIN + SMGNSDTC, data = cereb_samp))
```
Test if mito is all RIN
```{r}
## Get all brain mito clusters labeled
clusters_to_pull <- NULL
for (tiss_ind in seq_along(cluster_list)) {
    current_tiss <- names(cluster_list)[tiss_ind]
    if (!str_detect(current_tiss, "brain")) {
        next()
    }
    current_tiss_clust <- cluster_list[[tiss_ind]]
    for (cluster_ind in seq_along(current_tiss_clust)) {
        cluster_name <- names(current_tiss_clust)[cluster_ind]
        cur_genes <- current_tiss_clust[[cluster_ind]]
        if (cluster_name == "X") {
            next()
        }
        if (any(cluster_mito %in% cur_genes)) {
            clusters_to_pull<- rbind(clusters_to_pull,
                                     cbind(current_tiss,cluster_name))
        }
        
    }
}

## Pull said clusters
profs_mito <- ZscoreProfilePuller(r_name_vect = clusters_to_pull[,1],
                                  "../../MARCC output/variance_profiles_kendall/")

for_model <- NULL

for (row_ind in seq(nrow(clusters_to_pull))) {
    current_df <- profs_mito[[clusters_to_pull[row_ind,1]]]
    new_rows <- cbind(current_df[,c("SUBJID", "SAMPID", clusters_to_pull[row_ind,2])],
             clusters_to_pull[row_ind,1])
    colnames(new_rows) <- c("SUBJID", "SAMPID", "mito_cluster", "tissue")
    for_model <- rbind(for_model, new_rows)
}

## Generalized linear model
for_model <- left_join(for_model, samp_dat) %>%
    left_join(.,phen_dat)

model_out <- lmer(mito_cluster ~ SMRIN + SMTSISCH + SEX + AGE + (1|tissue) + (1|SUBJID), data = for_model)
summary(model_out)
```

Substantia nigra question
```{r}
substantia_nigra <- brain_profs$brain_substantia_nigra %>%
    left_join(., phen_dat)

ggplot(substantia_nigra, aes(AGE, A, color = factor(MHPRKNSN))) +
    geom_point()
```

